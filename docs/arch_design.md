# Project: Digital Soul 技术架构说明书

## 1. 系统总体架构

本系统采用 **“环境-意识-表现”分离的三层架构**。核心思想是将“物理法则”（环境）与“自由意志”（AI）解耦，通过标准化的接口进行交互。

*   **表现层 (Client)**：负责 2D 像素画面的渲染、用户交互及数据可视化。
*   **环境层 (Server/World Engine)**：负责维护物理世界的规则、时间流逝、地理位置及数值计算。它是客观真理的维护者。
*   **意识层 (AI Service/Soul Core)**：负责驱动 Agent 的行为，包含记忆、思考、决策与反思机制。它是主观体验的产生者。

## 2. 核心模块详细设计

### A. 环境层 (The World - Backend)

环境层是系统的基石，是一个基于 **Tick（时间片）** 驱动的模拟引擎。

1.  **时空系统 (Space-Time System)**
    *   **时间引擎**：实现游戏时间与现实时间的映射（如 1 现实秒 = 1 游戏分钟）。管理昼夜交替、季节变换，并广播时间事件（如“天黑了”）。
    *   **地理网格 (Grid System)**：将世界划分为网格（Tile），每个网格具有属性（通过性、功能区类型）。管理实体（Agent、NPC、物品）的空间位置坐标。

2.  **物理与交互引擎 (Interaction Engine)**
    *   **行动解析器**：接收 Agent 的意图（如“去工作”），验证其物理可行性（距离是否足够、门是否开启）。
    *   **资源系统**：管理金钱、物品的流转。
    *   **状态动力学模块**：实现设计文档中的数值守恒逻辑。例如，当 Agent 执行“996工作”时，原子化地执行 `Health -= x`, `Wealth += y` 的数值变更，确保数据一致性。

3.  **NPC 行为树 (Behavior Trees)**
    *   对于非 LLM 驱动的 NPC（如工贼、享乐者），采用传统的行为树或状态机（FSM）控制，保证其行为的确定性和对 Agent 的持续干扰能力。

### B. 意识层 (The Soul - AI Core)

这是系统最复杂的部分，负责模拟 Agent 的心理活动。

1.  **感知过滤器 (Perception Filter)**
    *   **信息降噪**：环境层产生大量原始数据（坐标、天气、周围所有人的喊话），感知过滤器根据 Agent 的注意力机制，筛选出关键信息，转化为第一人称的自然语言描述（Prompt）。

2.  **记忆系统 (Memory System)**
    *   **工作记忆 (Short-term)**：维护一个固定长度的上下文窗口，存储当前的对话和最近发生的事件。
    *   **向量记忆库 (Long-term)**：将重要经历（如“因没钱被房东赶出”）向量化存储。当遇到相似情境时，通过语义检索（RAG）唤醒相关记忆。
    *   **记忆压缩器 (Summarizer)**：在虚拟睡眠阶段，调用 LLM 将一天的流水账压缩为“日记”和“核心观点”，存入长期记忆。

3.  **决策与反思引擎 (Reasoning Engine)**
    *   **思维链 (CoT) 生成器**：在做出动作前，强制 Agent 进行内心独白，权衡 `Health` vs `Wealth`。
    *   **反思 (Reflection) 模块**：一个独立的异步进程。在 Agent 睡眠时启动，分析当天的“日记”，更新 Agent 的 `Values`（价值观）字段，作为次日决策的 System Prompt（最高指令）。

### C. 表现层 (The View - Frontend)

1.  **渲染引擎**
    *   采用 2D 游戏引擎技术，读取环境层的网格数据进行地图绘制。
    *   实现平滑插值，让 Agent 的移动看起来流畅，尽管后端是离散的网格跳跃。

2.  **数据监视器 (Observer Dashboard)**
    *   **思维气泡**：实时订阅意识层的 Log，将 CoT 内容显示在 Agent 头顶。
    *   **状态面板**：实时同步 Health/Sanity 等数值。
    *   **上帝视角工具**：允许观察者点击任意 Agent，查看其“记忆库”和“日记”内容。

## 3. 关键业务流程设计

### 流程一：单帧决策循环 (The Agent Loop)
1.  **观察 (Observe)**：环境层推送当前视野内的数据（如：面前有一家 996 公司，当前精力 80%）。
2.  **检索 (Retrieve)**：意识层在记忆库中检索与“工作”、“疲劳”相关的过往经验。
3.  **思考 (Think)**：LLM 结合当前状态 + 检索到的记忆 + 核心价值观，生成内心独白：“上次这么累的时候工作晕倒了，今天还是休息吧。”
4.  **行动 (Act)**：输出指令 `MoveTo(Park)`。
5.  **反馈 (Feedback)**：环境层执行移动，扣除少量精力，增加精神值，返回新状态。

### 流程二：日结算与反思 (Nightly Routine)
1.  **休眠**：环境时间到达 24:00，Agent 强制进入睡眠状态，切断外界感知。
2.  **回顾**：提取当日所有短期记忆。
3.  **反思**：LLM 思考：“今天为了省钱没吃饭，导致健康大幅下降，这不值得。”
4.  **写入**：将“健康比金钱重要”这一新信条写入长期记忆/价值观配置中。
5.  **遗忘**：清空短期记忆，仅保留压缩后的日记，迎接新的一天。

## 4. 数据结构与存储规划

为支持复杂的查询和回溯，建议采用混合存储方案：

1.  **关系型数据库 (SQL)**
    *   存储世界基础数据：地图数据、物品属性、NPC 配置。
    *   存储结构化日志：每一时刻的 Agent 四维状态 (H/S/W/E)，用于生成统计图表。

2.  **向量数据库 (Vector DB)**
    *   存储 Agent 的非结构化记忆（文本 + Embedding），用于语义搜索。

3.  **JSON/文档存储**
    *   存储 Agent 的配置文件（性格卡）、每日日记、反思总结。

## 5. 技术栈推荐

为了高效实现上述架构，建议采用以下技术栈：

*   **后端/AI 服务**：**Python**
    *   框架：FastAPI (高性能异步接口，适合处理大量 Agent 并发请求)。
    *   AI 编排：LangChain 或原生 OpenAI SDK (用于管理 Prompt 和记忆流)。
    *   数据处理：Pandas (用于分析数值平衡)。
*   **前端/可视化**：**TypeScript + Vue3/React**
    *   游戏引擎：Phaser 3 (成熟的 2D Web 游戏引擎) 或 Pixi.js。
*   **数据库**：
    *   主库：SQLite (开发期) -> PostgreSQL (生产期)。
    *   向量库：ChromaDB (轻量级，易于本地部署)。